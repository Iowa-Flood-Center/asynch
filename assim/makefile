#Compilers
PCC = mpicc

#Flags for performance
#OPTFLAGS = -O3 -march=native

#Flags for debugging
DBFLAGS = -g
#DBFLAGS = -g -Wall -Wextra #-Wpadded

#Locations
OBJDIR = ./objects

#Header and libraries
#HEADERS = -I/usr/pgsql-8.4/include/ -I/home/ssma/NewAsynchVersion/ -I/home/ssma/metis-5.0.2/include/
#LIBSLOC = -L/usr/pgsql-8.4/lib/ -L/home/ssma/NewAsynchVersion/libs/ -Wl,-rpath=/home/ssma/NewAsynchVersion/libs/ -L/home/ssma/metis-5.0.2/build/Linux-x86_64/libmetis
HEADERS = -I/usr/include/postgresql/ -I/home/scott/ifc/ssma/NewAsynchVersion/
LIBSLOC = -L/home/scott/ifc/ssma/NewAsynchVersion/libs/ -Wl,-rpath=/home/scott/ifc/ssma/NewAsynchVersion/libs/
LIBS = $(LIBSLOC) -lm -lpq -lasynch -lssh2 -lmetis
TAOFLAGS = -I/home/scott/petsc-3.7.3/arch-linux2-c-debug/include/ -I/home/scott/petsc-3.7.3/include/ -L/home/scott/petsc-3.7.3/arch-linux2-c-debug/lib/ -Wl,-rpath=/home/scott/petsc-3.7.3/arch-linux2-c-debug/lib/ -lpetsc
# Note: I'm not sure why, but I had to include a -Wl,-rpath for Petsc on my new laptop. I never needed this before...

#Objects
ASYNCHDISTOBJS = $(addprefix $(OBJDIR)/,asynchdist.o)
FORECASTEROBJS = $(addprefix $(OBJDIR)/,forecaster_methods.o)
FORECASTER_MAPSOBJS = $(addprefix $(OBJDIR)/,forecaster_maps.o)
FORECASTER_MAPS_END_OBJS = $(addprefix $(OBJDIR)/,forecaster_maps_end.o)
ASYNCHPERSISOBJS = $(addprefix $(OBJDIR)/,asynchpersis.o)
ASYNCHPERSIS_END_OBJS = $(addprefix $(OBJDIR)/,asynchpersis_end.o)
WHATIFOBJS = $(addprefix $(OBJDIR)/,whatif.o)
ASYNCHCUSTOMOBJS = $(addprefix $(OBJDIR)/,asynchdist_custom.o)
ASSIMOBJS = $(addprefix $(OBJDIR)/,assimlsmethods.o assim_models.o)
ASSIMLEASTSQUARESLINEAROBJS = $(addprefix $(OBJDIR)/,assimLeastSquaresLinear.o)
ASSIMPERSISOBJS = $(addprefix $(OBJDIR)/,assimpersis.o)
ASSIMPERSISENDOBJS = $(addprefix $(OBJDIR)/,assimpersis_end.o)

###########

#ASSIMOBJS = $(addprefix $(OBJDIR)/,assim.o assimmethods.o parmathmethods.o)
ASSIMSERIALOBJS = $(addprefix $(OBJDIR)/,assimserial.o assimmethods.o parmathmethods.o)
EXTENDEDOBJS = $(addprefix $(OBJDIR)/,assimExtended.o assimmethods.o parmathmethods.o)
EXTENDEDAPPROXSERIALOBJS = $(addprefix $(OBJDIR)/,assimExtendedApproxSerial.o assimmethods.o parmathmethods.o)
#EXTENDEDDIRECTSERIALOBJS = assimExtendedDirectSerial.o assimmethods.o parmathmethods.o
EXTENDEDDIRECTSERIALNEWOBJS = $(addprefix $(OBJDIR)/,assimExtendedDirectSerialNew.o assimmethods.o parmathmethods.o)
EXTENDEDDIRECTSERIALOLDOBJS = $(addprefix $(OBJDIR)/,assimExtendedDirectSerialOld.o assimmethods.o parmathmethods.o)
ASSIMLEASTSQUARESOBJS = $(addprefix $(OBJDIR)/,assimLeastSquaresFull.o assimlsmethods.o)
MAPSSTOPOBJS = $(addprefix $(OBJDIR)/,forecaster_maps_stop.o)
ASSIMSCALEOBJS = $(addprefix $(OBJDIR)/,assim_scale.o)

#How to compile and link
$(OBJDIR)/%.o: %.c
	$(PCC) -c $*.c $(HEADERS) $(DBFLAGS) $(OPTFLAGS) $(EXTRA_FLAGS) -o $(OBJDIR)/$*.o

#$(WITHTAOOBJDIR)/%.o: %.c
#	$(PCC) -c $*.c $(HEADERS) $(DBFLAGS) $(OPTFLAGS) $(TAOFLAGS) -o $(WITHTAOOBJDIR)/$*.o

ASYNCH: $(ASYNCHDISTOBJS)
	$(PCC) $(ASYNCHDISTOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o ASYNCH

FORECASTER_MAPS: $(FORECASTEROBJS) $(FORECASTER_MAPSOBJS)
	$(PCC) $(FORECASTEROBJS) $(FORECASTER_MAPSOBJS) $(LIBS) $(FLAGS) $(DBFLAGS) $(OPTFLAGS) -o FORECASTER_MAPS

FORECASTER_MAPS_END: $(FORECASTEROBJS) $(FORECASTER_MAPS_END_OBJS)
	$(PCC) $(FORECASTEROBJS) $(FORECASTER_MAPS_END_OBJS) $(LIBS) $(FLAGS) $(DBFLAGS) $(OPTFLAGS) -o FORECASTER_MAPS_END

ASYNCHPERSIS: $(FORECASTEROBJS) $(ASYNCHPERSISOBJS)
	$(PCC) $(FORECASTEROBJS) $(ASYNCHPERSISOBJS) $(LIBS) $(FLAGS) $(DBFLAGS) $(OPTFLAGS) -o ASYNCHPERSIS

ASYNCHPERSIS_END: $(FORECASTEROBJS) $(ASYNCHPERSIS_END_OBJS)
	$(PCC) $(FORECASTEROBJS) $(ASYNCHPERSIS_END_OBJS) $(LIBS) $(FLAGS) $(DBFLAGS) $(OPTFLAGS) -o ASYNCHPERSIS_END

WHATIF: $(WHATIFOBJS)
	$(PCC) $(WHATIFOBJS) $(LIBS) $(FLAGS) $(DBFLAGS) $(OPTFLAGS) -o WHATIF

ASYNCHCUSTOM: $(ASYNCHCUSTOMOBJS)
	$(PCC) $(ASYNCHCUSTOMOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o ASYNCHCUSTOM

BUILDASSIMLEASTSQUARESLINEAR: EXTRA_FLAGS=$(TAOFLAGS)
BUILDASSIMLEASTSQUARESLINEAR: ASSIMLEASTSQUARESLINEAR

ASSIMLEASTSQUARESLINEAR: $(ASSIMOBJS) $(ASSIMLEASTSQUARESLINEAROBJS)
	$(PCC) $(ASSIMOBJS) $(ASSIMLEASTSQUARESLINEAROBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) $(TAOFLAGS) -o ASSIMLEASTSQUARESLINEAR

BUILDASSIMPERSIS: EXTRA_FLAGS=$(TAOFLAGS)
BUILDASSIMPERSIS: ASSIMPERSIS

ASSIMPERSIS: $(ASSIMOBJS) $(FORECASTEROBJS) $(ASSIMPERSISOBJS)
	$(PCC) $(ASSIMOBJS) $(FORECASTEROBJS) $(ASSIMPERSISOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) $(TAOFLAGS) -o ASSIMPERSIS

BUILDASSIMPERSIS_END: EXTRA_FLAGS=$(TAOFLAGS)
BUILDASSIMPERSIS_END: ASSIMPERSIS_END

ASSIMPERSIS_END: $(ASSIMOBJS) $(FORECASTEROBJS) $(ASSIMPERSISENDOBJS)
	$(PCC) $(ASSIMOBJS) $(FORECASTEROBJS) $(ASSIMPERSISENDOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) $(TAOFLAGS) -o ASSIMPERSIS_END

#########

ASSIM: $(SHAREDOBJS) $(ASSIMOBJS)
	$(PCC) $(SHAREDOBJS) $(ASSIMOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o ASSIM

ASSIMSERIAL: $(SHAREDOBJS) $(ASSIMSERIALOBJS)
	$(PCC) $(SHAREDOBJS) $(ASSIMSERIALOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o ASSIMSERIAL

EXTENDED: $(SHAREDOBJS) $(EXTENDEDOBJS)
	$(PCC) $(SHAREDOBJS) $(EXTENDEDOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o EXTENDED

EXTENDEDAPPROXSERIAL: $(SHAREDOBJS) $(EXTENDEDAPPROXSERIALOBJS)
	$(PCC) $(SHAREDOBJS) $(EXTENDEDAPPROXSERIALOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o EXTENDEDAPPROXSERIAL

#EXTENDEDDIRECTSERIAL: $(SHAREDOBJS) $(EXTENDEDDIRECTSERIALOBJS)
#	$(PCC) $(SHAREDOBJS) $(EXTENDEDDIRECTSERIALOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o EXTENDEDDIRECTSERIAL

EXTENDEDDIRECTSERIALNEW: $(SHAREDOBJS) $(EXTENDEDDIRECTSERIALOBJSNEW)
	$(PCC) $(SHAREDOBJS) $(EXTENDEDDIRECTSERIALOBJSNEW) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o EXTENDEDDIRECTSERIALNEW

EXTENDEDDIRECTSERIALOLD: $(SHAREDOBJS) $(EXTENDEDDIRECTSERIALOBJSOLD)
	$(PCC) $(SHAREDOBJS) $(EXTENDEDDIRECTSERIALOBJSOLD) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o EXTENDEDDIRECTSERIALOLD

ASSIMLEASTSQUARES:
	$(MAKE) ASSIMLEASTSQUARES_TARGET EXTRA_FLAGS="$(TAOFLAGS)"

ASSIMLEASTSQUARES_TARGET: $(SHAREDOBJS) $(ASSIMLEASTSQUARESOBJS)
	$(PCC) $(SHAREDOBJS) $(ASSIMLEASTSQUARESOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) $(TAOFLAGS) -o ASSIMLEASTSQUARES

MAPS_STOP: $(SHAREDOBJS) $(MAPSSTOPOBJS) $(FORECASTEROBJS)
	$(PCC) $(SHAREDOBJS) $(MAPSSTOPOBJS) $(FORECASTEROBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o MAPS_STOP

ASSIMSCALE: $(SHAREDOBJS) $(FORECASTEROBJS) $(ASSIMSCALEOBJS)
	$(PCC) $(SHAREDOBJS) $(FORECASTEROBJS) $(ASSIMSCALEOBJS) $(LIBS) $(DBFLAGS) $(OPTFLAGS) -o ASSIMSCALE



clean:
	rm -f $(OBJDIR)/*.o
	rm -f ASYNCH
	rm -f FORECASTER_MAPS
	rm -f FORECASTER_MAPS_END
	rm -f ASYNCHPERSIS
	rm -f ASYNCHPERSIS_END
	rm -f WHATIF
	rm -f ASYNCHCUSTOM
	rm -f ASSIMLEASTSQUARESLINEAR
	rm -f ASSIMPERSIS
######
	rm -f ASSIM
	rm -f ASSIMSERIAL
	rm -f EXTENDED
	rm -f EXTENDEDAPPROXSERIAL
#	rm -f EXTENDEDDIRECTSERIAL
	rm -f EXTENDEDDIRECTSERIALNEW
	rm -f EXTENDEDDIRECTSERIALOLD
	rm -f ASSIMLEASTSQUARES
	rm -f MAPS_STOP
	rm -f ASSIMSCALE

